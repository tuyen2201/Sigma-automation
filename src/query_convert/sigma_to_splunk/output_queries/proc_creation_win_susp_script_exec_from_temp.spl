index=* sourcetype="WinEventLog:Security" EventCode=4688
 | search ((New_Process_Name="*\powershell.exe" OR New_Process_Name="*\pwsh.exe" OR New_Process_Name="*\mshta.exe" OR New_Process_Name="*\wscript.exe" OR New_Process_Name="*\cscript.exe") AND (Process_Command_Line="*\Windows\Temp*" OR Process_Command_Line="*\Temporary Internet*" OR Process_Command_Line="*\AppData\Local\Temp*" OR Process_Command_Line="*\AppData\Roaming\Temp*" OR Process_Command_Line="*%TEMP%*" OR Process_Command_Line="*%TMP%*" OR Process_Command_Line="*%LocalAppData%\Temp*")) | search ((Process_Command_Line="* >*" OR Process_Command_Line="*Out-File*" OR Process_Command_Line="*ConvertTo-Json*" OR Process_Command_Line="*-WindowStyle hidden -Verb runAs*" OR Process_Command_Line="*\Windows\system32\config\systemprofile\AppData\Local\Temp\Amazon\EC2-Windows\*"))
| table _time, New_Process_Name, Process_Command_Line