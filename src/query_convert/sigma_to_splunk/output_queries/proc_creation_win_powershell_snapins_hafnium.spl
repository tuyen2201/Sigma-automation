index=* sourcetype="WinEventLog:Security" EventCode=4688
 | search (New_Process_Name="*['\\powershell.exe', '\\pwsh.exe']" OR Original_File_Name="['PowerShell.EXE', 'pwsh.dll']") | search (Process_Command_Line="*Add-PSSnapin*") | search ((Process_Command_Line="*Microsoft.Exchange.Powershell.Snapin*" OR Process_Command_Line="*Microsoft.Exchange.Management.PowerShell.SnapIn*")) | search (Parent_Process_Name="C:\Windows\System32\msiexec.exe" AND Process_Command_Line="*$exserver=Get-ExchangeServer ([Environment]::MachineName) -ErrorVariable exerr 2> $null*")
| table _time, New_Process_Name, Process_Command_Line